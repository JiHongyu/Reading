网络协议简述
===================================
##OSI模型
###物理层
接口及传输媒介的物理特性；

比特表示；

数据率；

比特同步；

线路配置：共享，独占；

物理拓扑：星，环，总线；

传输方式：单工，双工，全双工；

###数据链路层
帧格式；
物理编址；
流量控制；
差错控制；
接入控制；

###网络层
逻辑地址；
路由选择；

###传输层
服务点编址；
分段与组装；
连接控制；
流量控制；
差错控制；

###会话层
对话控制：
同步

###表示层
转换；加密；压缩；

###应用层


##TCP/IP协议簇

###物理层
没有规定特定的协议

###数据链路层
没有规定特定的协议

###网络层
IP协议

###传输层
TCP，UDP

##网络编制
物理地址，逻辑地址，端口地址，特定应用地址。

物理和逻辑地址都应支持单播，多播和广播服务。

特定应用地址：例如网络链接。

##数据链路层

###以太网802.3
MAC地址：6字节

单播地址：目的地址的第一个字节最低位为0

多播地址：目的地址的第一个字节最低位为1

广播地址：目的地址的所有字节位为1

CSMA/CD：带碰撞监测的载波侦听多路复用

###无线局域网802.11

服务类型：基本服务集（BSS），扩展服务集（ESS）

CSMA/CA：带碰撞避免的载波监听多路复用

网络层
===================================
交换方式：
1.电路交换
2.**分组交换**

分组交换网络也存在两种：数据报方式（无连接），虚电路方式（有连接）。

##IPv4

地址分类：

+ A类：0...... (  0~127.xxx.xxx.xxx)
+ B类：10..... (128~191.xxx.xxx.xxx)
+ C类：110.... (192~223.xxx.xxx.xxx)
+ D类：1110... (224~239.xxx.xxx.xxx)
+ E类：1111... (240~255.xxx.xxx.xxx)

特殊地址：

+ 受限广播地址：地址块全1。在当前网络下的受限广播
+ 环回地址：127.x.x.x。
+ 专有地址：10.x.x.x/8, 172.16.x.x/12, 192,168.x.x/16, 169.254.x.x/16
+ 多播地址：224.x.x.x/4
+ 网络地址：一个地址块的首地址
+ 直接广播地址：一个地址块的末地址


无分类域间路由选择的子网划分，基于最大子网地址块的规则。

网络地址转换NAT：用于专有地址和全球地址之间的互相映射。在NAT技术中，通信必须由专有网络发起。

##IP分组的交付于转发

###基于目的地址的转发

最长掩码匹配原则

###基于标记的转发

多协议标记交换MPLS

##IPv4

不可靠的无连接数据报协议（最大努力交付）。
首部长度：$20\sim60$ Bytes，多余的有选项字段填充。IP数据报文长度$20 \sim 2^{16}-1$ Bytes。

###数据的分片
将IP数据按照MTU进行分片与重组。与之相关的首部字段包括
标识，标志，分片偏移

###选项
时间戳，

###检验和

校验首部


## ARP

将逻辑地址映射为物理地址。


## ICMP

可以细分为：差错报告报文和查询报文

### 差错报告报文

+ 终点不可达
+ 源点抑制
+ 超时
+ 参数问题
+ 改变路由

差错报告报文总是发送给最初的数据源。

差错报告报文的数据部分包括原始IP报文的首部及前8个数据报文字节（包含端口号及传输层协议）；差错报告报文的首部有ICMP首部确定。ICMP报文最终是由IP封装传输的。

### 查询报文

+ 回送请求及回答
+ 时间戳请求及回答

应用场景： ping，traceroute


## 单播路由选择协议

自治系统（autonomous system，AS）：在一个管理机构管辖下的一组网络和路由器。在自治系统内的路由选择称为域内路由选择，在自治系统之间的路由选择称为域间路由选择。

常见的路由选择协议：

+ 域内
    * 距离向量（RIP）
    * 链路状态（OSPF）
+ 域间
    * 路径向量（BGP）


### 距离向量路由选择

模型：图模型，将网络的链路和路由器抽象为图的边和节点。

算法基础：Bellman-Ford算法，求解任意两点的最短路径。

具体细节：

+ 链路代价设为1；
+ 路由器接收邻居路由器信息异步地更新路由表（分布式）；
+ 路由表更新后将路由信息发送给邻居路由器

缺点：好消息传播得快，坏消息传播得慢

应用：RIPv1, RIPv2

### 链路状态路由选择

模型：图模型，将网络的链路和路由器抽象为图的边和节点。

算法基础：Dijkstra算法，求解单源路径最短路径算法。

具体细节：

+ 路由器按照一定规则向外传播其局部链路信息分组（LSP）；
+ 收集LSP，淘汰旧的LSP
+ 汇总LSP得到全局的链路信息
+ 利用Dijkstra算法求得最短路径树

应用：OSPF（Open Shortest Path First）

### OSPF

OSPF将一个自治系统划分为多个区域，在一个 **区域** 内使用 **洪泛法** 传播路由选择信息。区域边界路由器将一个区域的信息汇总起来发送给另一个区域。这种多级路由管理可以加纳少当路由器大量增加时的网络开销。

## 路径向量路由选择

基于路径信息的路由选择。

## UDP

一种无连接、不可靠的传输层协议。首部长度 8 Bytes。

## TCP

一种面向字节流的协议。

### TCP实现的基本服务：

+ 流交付服务：基于发送缓存和接收缓存；
+ 全双工通信；
+ 复用和解复用；
+ 面向连接服务；
+ 可靠服务：流量服务，差错控制，拥塞控制

### 编号系统：

为了管理数据流的发送和接收情况，TCP首部设定了两个字段 **序号** 和 **确认号** 作为管理数据流的措施。

序号和确认号都是32位无符号整数。序号一般随机起始。

序号：发送的报文数据的第一个字节的序号。当TCP报文不携带数据时，原则上序号字段是无意义的，但是一些携带控制信息的报文（用于建立连接和拆除链接）还是需要一个序号，以便接收方确认。

确认号：对收到的数据字节的确认，数值上表示为 **期望接收的下一个字节序号** 。注意确认号的 **累积属性** 。


### 建立连接

主机状态：

+ 服务器：被动打开，一直监听；
+ 客户端：主动打开。

建连步骤，三次握手（三个报文）：

1. 客户端发送 SYN报文 $s_1$。$s_1$ 里包含一个客户端初始序号；
2. 服务器接收 $s_1$ 并发送 SYN+ACK报文 $s_2$。$s_2$ 里包含服务器初始序号，对客户端的确认号，客户端的窗口大小参数；
3. 客户端接收 $s_2$ ，**客户端连接打开**，并发送 ACK报文 $s_3$。$s_3$ 包含对服务器的确认号，服务器的窗口大小参数，可能也有数据（可以开始进行数据传输了）；
4. 服务器接收 $s_3$，**服务器连接打开**。

注：ACK控制报文不携带数据就不消耗序号，SYN和FIN控制报文是需要的。

### 连接终止

服务器和客户端的任何一方都可以发起关闭连接，一般来说是由客户端发起的。连接终止的方法有两种：三次挥手，四次挥手（半关闭）。

#### 三次挥手（三个报文）

1. 客户端将发送报文的FIN标志置1，或仅仅发送一个FIN控制报文 $s_1$；
2. 服务器收到 $s_1$, 发送ACK+FIN报文 $s_2$；
3. 客户端收到 $s_2$，**客户端连接关闭**，并发送ACK报文 $s_3$；
4. 服务器收到 $s_3$，**服务器连接关闭**。

#### 四次挥手（四个报文）

三次挥手方法意味着连接的双方几乎同时关闭。然而四次挥手可以使一端连接关闭而另一端保持打开，即保证了单向的数据传输。注意，关闭是关闭的 **数据** 发送行为，控制消息报文还是可以发送的。

1. 客户端发送一个FIN报文 $s_1$。
2. 服务器接收 $s_1$，发送ACK报文 $s_2$，其序号为当前服务器向客户端发送成功的数据的最后一个字节序号，即$s_1$的 ACK$-1$；
3. 客户端收到 $s_2$，**客户端连接关闭**；
4. 然后就是服务器到客户端的单向数据传输；
4. 服务器发送一个FIN报文 $s_3$；
5. 客户端接收 $s_3$，发送ACK报文 $s_4$；
6. 服务器接收 $s_4$，**服务器连接关闭**。

### 连接复位

+ 一端向另一端并不存在的端口请求，另一端会返回RST报文；
+ 出现异常情况，某一端想放弃正在连接的链路，便会发送一个RST报文；
+ 当一端发现另一端已经空闲了很长一段时间了，便发送RST报文终止连接。

### 流量控制

TCP的流量是通过控制窗口大小来动态的控制的。

发送窗口：

+ 当接收有效ACK时，窗口减小；
+ 当接收rwnd（TCP报文窗口大小字段）时，窗口（可能）增大。

接收窗口：

+ 收到有效数据时，窗口减小；
+ 当进程提取出数据后，窗口变大。

一对发送——接收窗口的大小是一样的。

### 差错控制

差错控制包括：

+ 检验和：校验报文；
+ 序号+确认号机制：累积确认；
+ 重传：超时或者收到3个重复的ACK
+ 失序报文：暂存
+ FSM：太复杂了

### 拥塞控制

拥塞窗口cwnd：网络受限的窗口控制大小

TCP中真正的窗口大小$ = \min ( rwnd, cwnd ) $

+ 慢启动：指数增加。通过门限终止。
+ 拥塞避免：线性增加。门限也线性增加。
+ 拥塞检测：乘法减小。门限乘法减小
    * 超时：cwnd=1，慢启动开始
    * 3个重复ACK：cwnd=门限/2，拥塞避免开始

### TCP协议中几个关键计时器

#### 重传计时器

#### 持续计时器

#### 保活计时器

#### TIME-WAIT计时器

